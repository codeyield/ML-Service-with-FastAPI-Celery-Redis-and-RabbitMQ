version: "3.9"

services:

    # ML app
    mlapp:
        build:
            context: .
            dockerfile: docker/app/Dockerfile
        volumes:
            - .:/app
        depends_on:
            celery-worker:
                condition: service_started
            redis:
                condition: service_healthy
            rabbitmq:
                condition: service_healthy
        ports:
            - 8000:8000

    # Celery worker
    celery-worker:
        build:
            context: .
            dockerfile: docker/worker/Dockerfile
        volumes:
            - .:/app
            - ./.logs:/logs
        depends_on:
            - rabbitmq
            - redis

    # Redis
    redis:
        image: redis:7.0.15-alpine
        hostname: redis
        expose:
            - 6379
        healthcheck:
            test: ["CMD-SHELL", "redis-cli ping"]
            interval: 30s
            timeout: 10s
            retries: 3

    # RabbitMQ
    rabbitmq:
        image: rabbitmq:3.13.3-management-alpine
        hostname: rabbitmq3
        environment:
            - RABBITMQ_DEFAULT_USER=guest
            - RABBITMQ_DEFAULT_PASS=guest
        ports:
            - 15672:15672
        expose:
            - 5672
        healthcheck:
            test: ["CMD", "rabbitmqctl", "status"]
            interval: 30s
            timeout: 10s
            retries: 3

networks:
    default:
        name: bagel
